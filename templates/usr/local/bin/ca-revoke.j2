#!/bin/sh

USAGE_EXAMPLE="`basename "$0"` my-phone component"

if [ `id -u` -ne 0 ]; then
    printf "This script must be run as root.\n"
    exit 1
fi

if [ -z $1 ]; then
    printf "Please pass filename for certificate as first argument.\n"
    printf "example: $USAGE_EXAMPLE\n"
    exit 1
fi

if [ -z $2 ]; then
    printf "Please pass signing ca as second argument.\n"
    printf "example: $USAGE_EXAMPLE\n"
    exit 1
fi

CWD=`pwd`
cd /etc/ssl/{{ ca_name_short }}

if [ ! -f certs/$1.pem ];then
    exit 0
fi

SERIAL_FILE='ca/$2-ca/db/$2-ca.crt.srl'

openssl ca \
    -config etc/$2-ca.conf \
    -revoke certs/$1.pem \
    -crl_reason superseded \
    -passin file:ca/$2-ca/pwd/$2-ca.pwd

REVOKE_TIME=`date +"%Y%m%d_%H%M%S"`
REVOKE_LIST=`ls certs/$1.crt certs/$1.csr certs/$1.key certs/$1.pem etc/$1.conf`

if [ ! -d ./revoked/certs ]; then
    mkdir -p revoked/certs
fi

if [ ! -d ./revoked/etc ]; then
    mkdir -p revoked/etc
fi

if [ $? -eq 0 ]; then
    for cert in $REVOKE_LIST
    do
        mv $cert revoked/$cert.$REVOKE_TIME
    done
else
    exit 1
fi

cd $CWD
exit 0