#!/bin/sh

USAGE_EXAMPLE="`basename "$0"` my-name-mail email identity"

if [ `id -u` -ne 0 ]; then
    printf "This script must be run as root.\n"
    exit 1
fi

if [ -z $1 ]; then
    printf "Please pass filename for certificate as first argument.\n"
    printf "example: $USAGE_EXAMPLE\n"
    exit 1
fi

if [ -z $2 ]; then
    printf "Please pass config file without suffix as second argument.\n"
    printf "example: $USAGE_EXAMPLE\n"
    exit 1
fi

if [ -z $3 ]; then
    printf "Please pass signing ca as third argument.\n"
    printf "example: $USAGE_EXAMPLE\n"
    exit 1
fi

CWD=`pwd`
cd {{ ca_base_dir }}

SERIAL_FILE='ca/$2-ca/db/$2-ca.crt.srl'

if [ -f ${SERIAL_FILE} ]; then
    CREATE_SERIAL=''
else
    CREATE_SERIAL='-create_serial'
fi

pwgen -s 64 1 > ca/$3-ca/pwd/$1.pwd && \
chmod 600 ca/$3-ca/pwd/$1.pwd && \
openssl req -batch -new \
    -config etc/$1.conf \
    -out tmp/$1.csr \
    -keyout tmp/$1.key \
    -passout file:ca/$3-ca/pwd/$1.pwd && \
openssl ca -batch ${CREATE_SERIAL} \
    -config ca/etc/$3-ca.conf \
    -in tmp/$1.csr \
    -out tmp/$1.crt \
    -extensions $2_ext \
    -passin file:ca/$3-ca/pwd/$3-ca.pwd && \
openssl x509 -in tmp/$1.crt -out tmp/$1.pem -outform PEM

if [ $? -eq 0 ]; then
    mv tmp/$1.* certs/
else
    rm tmp/*
    exit 1
fi

cd $CWD
exit 0